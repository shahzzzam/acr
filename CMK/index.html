<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Customer-Managed Key (CMK) | Azure Container Registry</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/acr/assets/css/0.styles.fb4b111d.css" as="style"><link rel="preload" href="/acr/assets/js/app.9ca498d9.js" as="script"><link rel="preload" href="/acr/assets/js/2.a7687bda.js" as="script"><link rel="preload" href="/acr/assets/js/8.dd29001f.js" as="script"><link rel="prefetch" href="/acr/assets/js/10.117b2625.js"><link rel="prefetch" href="/acr/assets/js/11.67ee8141.js"><link rel="prefetch" href="/acr/assets/js/12.646970b1.js"><link rel="prefetch" href="/acr/assets/js/13.c209f8ba.js"><link rel="prefetch" href="/acr/assets/js/14.89cc0fa6.js"><link rel="prefetch" href="/acr/assets/js/15.d21e81f3.js"><link rel="prefetch" href="/acr/assets/js/16.6a58aa37.js"><link rel="prefetch" href="/acr/assets/js/17.f6b7bb95.js"><link rel="prefetch" href="/acr/assets/js/18.e44e0edc.js"><link rel="prefetch" href="/acr/assets/js/19.9fada1c3.js"><link rel="prefetch" href="/acr/assets/js/20.56c5942f.js"><link rel="prefetch" href="/acr/assets/js/21.ce172067.js"><link rel="prefetch" href="/acr/assets/js/22.d2921928.js"><link rel="prefetch" href="/acr/assets/js/23.e23eae01.js"><link rel="prefetch" href="/acr/assets/js/24.57ef5f18.js"><link rel="prefetch" href="/acr/assets/js/25.5f149a7a.js"><link rel="prefetch" href="/acr/assets/js/26.e039e2de.js"><link rel="prefetch" href="/acr/assets/js/27.c896a718.js"><link rel="prefetch" href="/acr/assets/js/28.cb2859c1.js"><link rel="prefetch" href="/acr/assets/js/29.59c0e1f7.js"><link rel="prefetch" href="/acr/assets/js/3.52dd993e.js"><link rel="prefetch" href="/acr/assets/js/30.3312a05a.js"><link rel="prefetch" href="/acr/assets/js/31.76877da3.js"><link rel="prefetch" href="/acr/assets/js/32.094af6d0.js"><link rel="prefetch" href="/acr/assets/js/33.ce0d01f9.js"><link rel="prefetch" href="/acr/assets/js/34.304ceef7.js"><link rel="prefetch" href="/acr/assets/js/4.5380f620.js"><link rel="prefetch" href="/acr/assets/js/5.f7f921a9.js"><link rel="prefetch" href="/acr/assets/js/6.50557e06.js"><link rel="prefetch" href="/acr/assets/js/7.1fc5e641.js"><link rel="prefetch" href="/acr/assets/js/9.bce5df44.js">
    <link rel="stylesheet" href="/acr/assets/css/0.styles.fb4b111d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/acr/" class="home-link router-link-active"><img src="/acr/files/acr.svg" alt="Azure Container Registry" class="logo"> <span class="site-name can-hide">Azure Container Registry</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/acr/" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/acr/#blog-posts" class="sidebar-link">Blog posts</a></li><li class="sidebar-sub-header"><a href="/acr/#links" class="sidebar-link">Links</a></li><li class="sidebar-sub-header"><a href="/acr/#providing-feedback" class="sidebar-link">Providing feedback</a></li><li class="sidebar-sub-header"><a href="/acr/#api-and-sdk-reference" class="sidebar-link">API and SDK reference</a></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Teleport</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tasks</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Authentication</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Integration</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Encryption</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/acr/CMK/" class="active sidebar-link">Customer-Managed Key (CMK)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/acr/CMK/#whitelist-your-subscription-to-use-the-feature" class="sidebar-link">Whitelist your subscription to use the feature</a></li><li class="sidebar-sub-header"><a href="/acr/CMK/#deploy-a-registry-with-cmk-enabled" class="sidebar-link">Deploy a registry with CMK enabled</a></li><li class="sidebar-sub-header"><a href="/acr/CMK/#login-and-use-the-registry" class="sidebar-link">Login and use the registry</a></li><li class="sidebar-sub-header"><a href="/acr/CMK/#feedback" class="sidebar-link">Feedback</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="customer-managed-key-cmk"><a href="#customer-managed-key-cmk" class="header-anchor">#</a> Customer-Managed Key (CMK)</h1> <p>Customer-Managed Key (CMK) or Bring your own key (BYOK) allows customers to configure customer-managed keys for Azure Container Registry (ACR) encryption. All customer-managed keys must be stored in an Azure Key Vault.</p> <p>In this version of the API, you can create a new Premium container registry with CMK can be enabled using an Azure ARM template.</p> <blockquote><p><strong>Note:</strong> The  CLI  and portal experience will light up soon.</p></blockquote> <h3 id="current-limitations"><a href="#current-limitations" class="header-anchor">#</a> Current limitations</h3> <ul><li>Disabling encryption for a registry is not supported.</li> <li>Other registry features like geo-replication, content-trust and VNet integration will also be supported in a future release</li> <li>This feature is only enabled on a newly created registry</li></ul> <h2 id="whitelist-your-subscription-to-use-the-feature"><a href="#whitelist-your-subscription-to-use-the-feature" class="header-anchor">#</a> Whitelist your subscription to use the feature</h2> <p>At this time, you must request access to use this capability. To do so, please contact acrsup@microsoft.com.</p> <h2 id="deploy-a-registry-with-cmk-enabled"><a href="#deploy-a-registry-with-cmk-enabled" class="header-anchor">#</a> Deploy a registry with CMK enabled</h2> <p>Follow these steps to create a registry with CMK enabled using an ARM template. Note that we will create a Key Vault and Key using CLI as we do not have ARM support for these scenarios.</p> <h3 id="_1-create-a-resource-group"><a href="#_1-create-a-resource-group" class="header-anchor">#</a> 1. Create a resource group</h3> <p>Create a resource group for creating the Key Vault and Keys.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az group create -g <span class="token operator">&lt;</span>resource-group-name<span class="token operator">&gt;</span> -l <span class="token operator">&lt;</span>location<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_2-create-a-key-vault"><a href="#_2-create-a-key-vault" class="header-anchor">#</a> 2. Create a key vault</h3> <p>Create a key vault to store customer-managed keys for registry encryption. This key vault should have two key protection settings enabled - Soft Delete and Do Not Purge.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az keyvault create --name <span class="token operator">&lt;</span>key-vault-name<span class="token operator">&gt;</span> -g <span class="token operator">&lt;</span>resource-group-name<span class="token operator">&gt;</span> --enable-soft-delete --enable-purge-protection
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_3-create-a-key-and-get-the-key-id"><a href="#_3-create-a-key-and-get-the-key-id" class="header-anchor">#</a> 3. Create a key and get the key ID</h3> <p>Create a key and get the full key ID.</p> <blockquote><p><strong>Note:</strong> if you skip the step because you have an existing key, make sure use a full key ID with version</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code> <span class="token assign-left variable">KEK</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>az keyvault key create --name <span class="token operator">&lt;</span>key-name<span class="token operator">&gt;</span> --vault-name <span class="token operator">&lt;</span>key-vault-name<span class="token operator">&gt;</span> --query key.kid -o tsv<span class="token variable">)</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_4-create-a-registry-with-cmk-enabled"><a href="#_4-create-a-registry-with-cmk-enabled" class="header-anchor">#</a> 4. Create a registry with CMK enabled</h3> <p>Download the <a href="https://github.com/Azure/acr/blob/master/docs/CMK/template.json" target="_blank" rel="noopener noreferrer">template.json file<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Run the following command to create a registry with CMK enabled. Note that you need to provide the key vault name that you just created. Registry and user assigned managed identity will be created by the template.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az group deployment create -g <span class="token operator">&lt;</span>resource-group-name<span class="token operator">&gt;</span> --template-file <span class="token operator">&lt;</span>template.json<span class="token operator">&gt;</span> --parameters <span class="token assign-left variable">vault_name</span><span class="token operator">=</span><span class="token operator">&lt;</span>key-vault-name<span class="token operator">&gt;</span> <span class="token assign-left variable">registry_name</span><span class="token operator">=</span><span class="token operator">&lt;</span>registry-name<span class="token operator">&gt;</span> <span class="token assign-left variable">identity_name</span><span class="token operator">=</span><span class="token operator">&lt;</span>managed-identity<span class="token operator">&gt;</span> <span class="token assign-left variable">kek_id</span><span class="token operator">=</span><span class="token variable">$KEK</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_5-key-rotation"><a href="#_5-key-rotation" class="header-anchor">#</a> 5. Key rotation</h3> <p>You can rotate keys by creating a new key using step 3 and then using the new key in step 4 mentioned above.</p> <h3 id="_6-view-registry-encryption-settings"><a href="#_6-view-registry-encryption-settings" class="header-anchor">#</a> 6. View registry encryption settings</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az resource show --id <span class="token operator">&lt;</span>registry-resource-id<span class="token operator">&gt;</span> --query properties.encryption --api-version <span class="token number">2019</span>-12-01-preview
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="login-and-use-the-registry"><a href="#login-and-use-the-registry" class="header-anchor">#</a> Login and use the registry</h2> <h3 id="_1-login-to-your-registry"><a href="#_1-login-to-your-registry" class="header-anchor">#</a> 1. Login to your registry</h3> <div class="language-json line-numbers-mode"><pre class="language-json"><code>az acr login -n myacr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Follow <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication" target="_blank" rel="noopener noreferrer">this documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for authenticate your docker client to your container registry.</p> <h3 id="_2-push-images-to-your-registry"><a href="#_2-push-images-to-your-registry" class="header-anchor">#</a> 2. Push images to your registry</h3> <p>For pushing docker images on your registry, follow <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-get-started-docker-cli" target="_blank" rel="noopener noreferrer">this documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="feedback"><a href="#feedback" class="header-anchor">#</a> Feedback</h2> <p>For feedback on CMK, visit https://aka.ms/acr/issues.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azure/acr/edit/master/docs/CMK/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/acr/integration/change-analysis/" class="prev">
        Change Analysis
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/acr/assets/js/app.9ca498d9.js" defer></script><script src="/acr/assets/js/2.a7687bda.js" defer></script><script src="/acr/assets/js/8.dd29001f.js" defer></script>
  </body>
</html>
